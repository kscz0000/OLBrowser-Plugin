# 项目结构

本文档详细说明了图像处理工具箱项目的代码结构和组织方式。

---

## 目录

- [整体结构](#整体结构)
- [核心文件](#核心文件)
- [功能模块](#功能模块)
- [共享模块](#共享模块)
- [第三方库](#第三方库)
- [文档目录](#文档目录)

---

## 整体结构

```
OLBrowser-Plugin/                    # 项目根目录
├── manifest.json                    # 插件清单文件
├── background.js                    # 后台服务脚本
├── index.html                       # 主入口页面
├── main.js                          # 主页面逻辑
├── styles.css                       # 主样式表
│
├── image-compressor/                 # 图像压缩模块
├── svg-converter/                   # SVG 转换模块
│
├── shared/                          # 共享功能模块
├── lib/                               # 第三方库
├── icons/                             # 图标资源
├── docs/                              # 项目文档
├── LICENSE                             # 开源许可证
├── CONTRIBUTING.md                  # 贡献指南
└── CHANGELOG.md                     # 变更日志
```

---

## 核心文件

### manifest.json

**位置**：项目根目录

**作用**：定义浏览器插件的基本信息和权限

**关键配置**：

```json
{
  "manifest_version": 3,           // Manifest V3 版本
  "name": "图像处理工具箱",
  "version": "1.1.0",
  "description": "专业的本地图像处理解决方案",
  "permissions": [
    "activeTab",              // 激活标签页权限
    "storage",               // 本地存储权限
    "downloads"              // 文件下载权限
  ],
  "host_permissions": [
    "<all_urls>"           // 所有 URL 访问权限（用于内嵌页面）
  ],
  "background": {
    "service_worker": "background.js"    // 后台服务工作者
  },
  "action": {
    "default_title": "图像处理工具箱",
    "default_icon": {                    // 工具栏图标
      "16": "icons/icon16.png",
      "32": "icons/icon32.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  }
}
```

### background.js

**位置**：项目根目录

**作用**：后台服务工作器（Service Worker）

**主要功能**：

```javascript
// 处理插件图标点击事件
chrome.action.onClicked.addListener(() => {
  chrome.tabs.create({ url: 'index.html' });
});

// 监听来自内嵌页面的消息
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  // 处理请求
  sendResponse({ response: '处理结果' });
});
```

### index.html

**位置**：项目根目录

**作用**：主入口页面，工具选择界面

**关键元素**：

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>图像处理工具箱</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- 工具选择卡片 -->
  <div class="tool-selector">
    <div class="tool-card" onclick="openImageCompressor()">
      <h2>图像压缩</h2>
    </div>
    <div class="tool-card" onclick="openSvgConverter()">
      <h2>SVG 转图片</h2>
    </div>
  </div>
  
  <!-- 返回按钮 -->
  <button onclick="window.close()">关闭</button>
  
  <script src="main.js"></script>
</body>
</html>
```

### main.js

**位置**：项目根目录

**作用**：主页面逻辑控制

**主要功能**：

```javascript
// 打开图像压缩模块
function openImageCompressor() {
  window.location.href = 'image-compressor/index.html';
}

// 打开 SVG 转换模块
function openSvgConverter() {
  window.location.href = 'svg-converter/index.html';
}

// 处理返回按钮
window.addEventListener('close', () => {
  window.close();
});
```

### styles.css

**位置**：项目根目录

**作用**：全局样式表

**关键样式**：

```css
:root {
  --primary-color: #2C3E50;
  --secondary-color: #3498DB;
  --accent-color: #F39C12;
  --text-color: #333333;
  --bg-color: #F5F5F5;
}

body {
  font-family: 'Segoe UI', 'PingFang SC', sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--bg-color);
  color: var(--text-color);
}

.tool-card {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease;
}

.tool-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
```

---

## 功能模块

### image-compressor/

**位置**：`image-compressor/` 目录

**作用**：图像压缩功能模块

**文件结构**：

```
image-compressor/
├── index.html              # 压缩工具页面
├── main.js                # 压缩功能逻辑
└── style-refactored.css # 压缩模块样式
```

**主要功能**：

1. 文件上传和验证
2. 压缩参数配置
3. 批量处理队列管理
4. 并发控制和优化
5. 压缩结果展示
6. 批量下载功能

**核心 API 使用**：

```javascript
// Canvas API - 图像处理
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.drawImage(image, 0, 0, width, height);

// FileReader API - 文件读取
const reader = new FileReader();
reader.readAsDataURL(file);

// Blob API - 文件生成
const blob = new Blob([canvasData], { type: 'image/png' });
```

### svg-converter/

**位置**：`svg-converter/` 目录

**作用**：SVG 转图片功能模块

**文件结构**：

```
svg-converter/
├── index.html              # 转换工具页面
├── svg-converter.js      # 转换功能逻辑
└── svg-converter.css     # 转换模块样式
```

**主要功能**：

1. SVG 文件和代码上传
2. 转换参数配置
3. 批量转换任务管理
4. 实时进度显示
5. 转换结果预览
6. 批量下载功能

**核心 API 使用**：

```javascript
// Image 对象 - SVG 渲染
const img = new Image();
img.src = svgDataUrl;
img.onload = () => {
  // 渲染到 Canvas
};

// Canvas 绘制
canvas.width = outputWidth * scale;
canvas.height = outputHeight * scale;
ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

// 导出图片
canvas.toBlob((blob) => {
  // 下载 blob
}, 'image/png');
```

---

## 共享模块

### shared/

**位置**：`shared/` 目录

**作用**：跨模块共享的核心功能

**文件结构**：

```
shared/
├── file-validator.js        # 文件验证模块
├── secure-storage.js        # 安全存储模块
├── svg-security.js          # SVG 安全处理模块
├── pptx-processor.js       # PPTX 处理模块
├── resource-manager.js     # 资源管理模块
├── concurrency-controller.js # 并发控制模块
├── language-switch.js       # 语言切换模块
├── language-switch.css      # 语言切换样式
├── theme-switch.js         # 主题切换模块
├── theme-switch.css        # 主题切换样式
├── return-btn.js           # 返回按钮模块
├── uniform-buttons.js      # 统一按钮模块
├── uniform-buttons.css     # 统一按钮样式
└── fonts/                # 字体资源
```

#### file-validator.js

**功能**：文件类型、大小、内容验证

**核心方法**：

```javascript
class FileValidator {
  // 文件类型检查
  validateFileType(file) { return boolean; }
  
  // 文件大小检查
  validateFileSize(file) { return boolean; }
  
  // 魔数验证
  validateMagicNumbers(file) { return boolean; }
  
  // 文件名检查
  validateFileName(name) { return boolean; }
}
```

#### secure-storage.js

**功能**：加密本地存储和数据完整性校验

**核心方法**：

```javascript
class SecureStorage {
  // 加密存储
  set(key, value) { return Promise; }
  
  // 解密读取
  get(key) { return Promise; }
  
  // 数据完整性校验
  verifyIntegrity(key) { return Promise; }
}
```

#### svg-security.js

**功能**：SVG 内容安全清理和验证

**核心方法**：

```javascript
class SvgSecurity {
  // 危险标签过滤
  filterDangerousTags(svg) { return cleanedSvg; }
  
  // 危险属性过滤
  filterDangerousAttributes(svg) { return cleanedSvg; }
  
  // XXE 攻击防护
  preventXXE(svg) { return cleanedSvg; }
}
```

#### pptx-processor.js

**功能**：PPTX 文件解析和图片提取

**核心方法**：

```javascript
class PPTXProcessor {
  // 解析 PPTX 文件
  async parse(file) { return images; }
  
  // 图片提取
  extractImages(zipFile) { return imageFiles; }
  
  // 哈希去重
  deduplicateImages(images) { return uniqueImages; }
}
```

#### resource-manager.js

**功能**：资源注册、释放和内存管理

**核心方法**：

```javascript
class ResourceManager {
  // 注册资源
  register(type, resource) { }
  
  // 释放资源
  release(resource) { }
  
  // 清理过期资源
  cleanupExpired() { }
}
```

#### concurrency-controller.js

**功能**：任务队列和并发控制

**核心方法**：

```javascript
class ConcurrencyController {
  // 添加任务
  addTask(task) { }
  
  // 执行任务
  execute(task) { }
  
  // 并发控制
  getConcurrentLimit() { return number; }
}
```

---

## 第三方库

### lib/

**位置**：`lib/` 目录

**作用**：第三方依赖库

**文件结构**：

```
lib/
└── jszip.min.js          # JSZip 库（用于 PPTX 处理）
```

#### jszip.min.js

**用途**：解析和提取 PPTX 文件中的图片

**版本**：最新稳定版

**使用方式**：

```javascript
import JSZip from './lib/jszip.min.js';

// 创建 JSZip 实例
const zip = new JSZip();

// 加载 ZIP 文件
await zip.loadAsync(file);

// 提取文件
const files = zip.files;
```

---

## 文档目录

### docs/

**位置**：`docs/` 目录

**作用**：项目文档和用户指南

**文件结构**：

```
docs/
├── 用户指南/                          # 用户使用文档
│   ├── 快速开始.md              # 快速入门指南
│   ├── 功能说明.md              # 详细功能说明
│   └── 常见问题.md              # FAQ 和故障排除
└── 开发者文档/                      # 开发者文档
    ├── 项目结构.md                # 代码结构说明
    ├── 开发指南.md                # 开发流程和规范
    └── API文档.md                   # API 参考文档
```

---

## 代码规范

### JavaScript 规范

- 使用 ES6+ 语法特性
- 使用 `const` 和 `let` 代替 `var`
- 使用箭头函数
- 使用模板字符串
- 使用 JSDoc 风格的函数注释

### 命名规范

- **变量和函数**：驼峰命名（`camelCase`）
- **常量**：全大写下划线（`UPPER_SNAKE_CASE`）
- **私有属性**：下划线前缀（`_privateProperty`）
- **文件命名**：短横线分隔（`file-name.js`）

### 注释规范

- 复杂逻辑需要添加注释
- JSDoc 注释格式：

```javascript
/**
 * 压缩图片
 * @param {File} file - 要压缩的图片文件
 * @param {Object} options - 压缩选项
 * @returns {Promise<Blob>} - 压缩后的图片 blob
 */
async function compressImage(file, options) {
  // 实现代码
}
```

### 格式化

- 使用 4 空格缩进（非 Tab）
- 每行最大长度 100 字符
- 函数之间留一个空行

---

## 模块化设计

### 模块职责划分

| 模块 | 职责 | 依赖 |
|------|------|------|
| index.html + main.js | 主入口、路由控制 | 无 |
| image-compressor/ | 图像压缩功能 | shared/* |
| svg-converter/ | SVG 转换功能 | shared/* |
| shared/ | 共享功能模块 | 无 |
| background.js | 后台服务 | 无 |

### 模块通信

```javascript
// 主页面 → 功能模块
window.open('image-compressor/index.html');

// 功能模块 → 共享模块
import { FileValidator } from './shared/file-validator.js';

// 功能模块 → 后台服务
chrome.runtime.sendMessage({ action: 'compress' });
```

---

## 扩展开发

### 添加新功能模块

1. 在项目根目录创建新的功能目录
2. 添加相应的 HTML、CSS、JS 文件
3. 实现功能逻辑
4. 使用共享模块的公共功能
5. 在主页面添加入口

### 添加共享功能

1. 在 `shared/` 目录创建新的模块文件
2. 实现类和公共方法
3. 添加对应的 CSS 样式（如需要）
4. 导出类供其他模块使用
5. 更新文档说明新功能

---

## 测试

### 单元测试

```javascript
// 示例：文件验证测试
const validator = new FileValidator();
const validFile = new File(['image.png'], { type: 'image/png' });
assert(validator.validateFileType(validFile) === true);
```

### 集成测试

1. 在不同浏览器中加载插件
2. 测试所有功能模块
3. 验证边界情况
4. 性能测试

---

## 性能优化

### 前端优化

- 使用 Web Worker 进行繁重计算
- 懒加载非必要资源
- 使用 `requestAnimationFrame` 优化动画
- 避免强制同步布局（Reflow）

### 内存管理

- 及时释放 Canvas 和 Blob 资源
- 清理不再需要的大对象
- 使用对象池复用资源

### 加载优化

- 使用 CDN 加载第三方库
- 预加载关键资源
- 使用 `defer` 或 `async` 加载非关键脚本

---

## 安全性

### CSP 策略

```json
"content_security_policy": {
  "extension_pages": "script-src 'self'; object-src 'self'"
}
```

### 文件验证

- MIME 类型检查
- 扩展名验证
- 魔数验证
- 文件大小限制

### 数据安全

- 加密本地存储
- 输入清理和转义
- XSS 和 XXE 防护

---

## 部署

### 本地测试

1. 打开 Chrome/Edge
2. 加载为开发者模式插件
3. 测试所有功能
4. 检查控制台错误
5. 验证权限和存储

### 打包发布

1. 更新版本号（manifest.json）
2. 运行所有测试
3. 更新 CHANGELOG.md
4. 创建 Git 标签
5. 创建 GitHub Release

---

**文档更新时间**：2026 年 1 月  
**当前版本**：1.1.0
