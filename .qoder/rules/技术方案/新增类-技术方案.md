---
trigger: manual
alwaysApply: false
---
# Demo新增类技术方案模板

## 方案概述

### 项目背景
[简要描述项目的业务背景和解决的问题]

### 技术目标
- 实现[具体功能]的增删改查功能
- 支持[业务场景]的处理
- 满足[性能指标]要求
- 符合[安全规范]要求

### 技术栈
- **后端框架**: Spring Boot 2.7.x
- **数据库**: MySQL 8.0
- **缓存**: Redis 6.0
- **消息队列**: RocketMQ/RabbitMQ
- **搜索引擎**: Elasticsearch (如需要)
- **监控**: Prometheus + Grafana

## 架构设计

### 整体架构
```
前端应用
    ↓ HTTP/HTTPS
API网关
    ↓
应用层 (Application)
    ↓ 调用
业务逻辑层 (Domain)
    ↓ 调用
数据访问层 (Infrastructure)
    ↓
数据存储 (MySQL/Redis/ES)
```

### 模块划分
```
com.example.[业务].demo/
├── application/           # 应用层
│   ├── controller/       # RESTful接口
│   ├── dto/              # 数据传输对象
│   └── assembler/        # 对象转换器
├── domain/               # 领域层
│   ├── model/            # 领域模型
│   ├── service/          # 领域服务
│   ├── repository/       # 仓库接口
│   └── event/            # 领域事件
├── infrastructure/       # 基础设施层
│   ├── persistence/      # 数据访问实现
│   ├── cache/            # 缓存实现
│   └── messaging/        # 消息队列实现
└── config/               # 配置
    ├── database/         # 数据库配置
    ├── cache/            # 缓存配置
    └── security/         # 安全配置
```

## 领域模型设计

### 实体定义
```java
/**
 * Demo实体 - [业务描述]
 */
@Entity
@Table(name = "t_demo")
public class Demo extends BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "name", nullable = false, length = 100)
    private String name;
    
    @Column(name = "code", unique = true, nullable = false, length = 50)
    private String code;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false, length = 20)
    private DemoStatus status;
    
    @Column(name = "description", length = 500)
    private String description;
    
    @Column(name = "config", columnDefinition = "json")
    private String config;
    
    // 业务方法
    public void activate() {
        if (this.status == DemoStatus.ACTIVE) {
            throw new BusinessException("Demo已处于激活状态");
        }
        this.status = DemoStatus.ACTIVE;
        registerEvent(new DemoActivatedEvent(this.id));
    }
    
    public void deactivate() {
        if (this.status == DemoStatus.INACTIVE) {
            throw new BusinessException("Demo已处于停用状态");
        }
        this.status = DemoStatus.INACTIVE;
        registerEvent(new DemoDeactivatedEvent(this.id));
    }
}
```

### 值对象定义
```java
/**
 * Demo配置信息 - 值对象
 */
@Embeddable
public class DemoConfig {
    
    @Column(name = "config_key")
    private String key;
    
    @Column(name = "config_value")
    private String value;
    
    @Column(name = "config_type")
    private String type;
    
    // 业务校验方法
    public boolean isValid() {
        return StringUtils.isNotBlank(key) 
            && StringUtils.isNotBlank(value)
            && StringUtils.isNotBlank(type);
    }
}
```

### 枚举定义
```java
/**
 * Demo状态枚举
 */
public enum DemoStatus {
    ACTIVE("激活", "可用于业务操作"),
    INACTIVE("停用", "不可用于业务操作"),
    PENDING("待审核", "需要审核后才能使用");
    
    private final String name;
    private final String description;
    
    DemoStatus(String name, String description) {
        this.name = name;
        this.description = description;
    }
}
```

## 领域服务设计

### 核心业务服务
```java
/**
 * Demo领域服务
 */
@DomainService
public class DemoService {
    
    private final DemoRepository demoRepository;
    private final DemoValidator demoValidator;
    private final EventPublisher eventPublisher;
    
    /**
     * 创建Demo
     */
    @Transactional
    public Demo createDemo(CreateDemoCommand command) {
        // 1. 参数校验
        demoValidator.validateCreateCommand(command);
        
        // 2. 业务规则校验
        if (demoRepository.existsByCode(command.getCode())) {
            throw new BusinessException("Demo代码已存在");
        }
        
        // 3. 创建实体
        Demo demo = Demo.builder()
            .name(command.getName())
            .code(command.getCode())
            .status(DemoStatus.PENDING)
            .description(command.getDescription())
            .config(command.getConfig())
            .build();
        
        // 4. 保存实体
        demo = demoRepository.save(demo);
        
        // 5. 发布领域事件
        eventPublisher.publish(new DemoCreatedEvent(demo.getId()));
        
        return demo;
    }
    
    /**
     * 更新Demo
     */
    @Transactional
    public Demo updateDemo(Long id, UpdateDemoCommand command) {
        // 1. 查询实体
        Demo demo = demoRepository.findById(id)
            .orElseThrow(() -> new BusinessException("Demo不存在"));
        
        // 2. 参数校验
        demoValidator.validateUpdateCommand(command);
        
        // 3. 业务规则校验
        if (!demo.getCode().equals(command.getCode()) 
            && demoRepository.existsByCode(command.getCode())) {
            throw new BusinessException("Demo代码已存在");
        }
        
        // 4. 更新实体
        demo.setName(command.getName());
        demo.setCode(command.getCode());
        demo.setDescription(command.getDescription());
        demo.setConfig(command.getConfig());
        
        // 5. 保存实体
        demo = demoRepository.save(demo);
        
        // 6. 发布领域事件
        eventPublisher.publish(new DemoUpdatedEvent(demo.getId()));
        
        return demo;
    }
    
    /**
     * 删除Demo
     */
    @Transactional
    public void deleteDemo(Long id) {
        // 1. 查询实体
        Demo demo = demoRepository.findById(id)
            .orElseThrow(() -> new BusinessException("Demo不存在"));
        
        // 2. 业务规则校验
        if (demo.getStatus() == DemoStatus.ACTIVE) {
            throw new BusinessException("激活状态的Demo不能删除");
        }
        
        // 3. 删除实体
        demoRepository.delete(demo);
        
        // 4. 发布领域事件
        eventPublisher.publish(new DemoDeletedEvent(demo.getId()));
    }
    
    /**
     * 激活Demo
     */
    @Transactional
    public void activateDemo(Long id) {
        Demo demo = demoRepository.findById(id)
            .orElseThrow(() -> new BusinessException("Demo不存在"));
        demo.activate();
        demoRepository.save(demo);
    }
    
    /**
     * 停用Demo
     */
    @Transactional
    public void deactivateDemo(Long id) {
        Demo demo = demoRepository.findById(id)
            .orElseThrow(() -> new BusinessException("Demo不存在"));
        demo.deactivate();
        demoRepository.save(demo);
    }
}
```

### 查询服务设计
```java
/**
 * Demo查询服务
 */
@DomainService
public class DemoQueryService {
    
    private final DemoRepository demoRepository;
    private final CacheManager cacheManager;
    
    /**
     * 根据ID查询Demo
     */
    @Cacheable(value = "demo", key = "#id")
    public DemoDTO findById(Long id) {
        return demoRepository.findById(id)
            .map(DemoDTO::fromEntity)
            .orElse(null);
    }
    
    /**
     * 分页查询Demo
     */
    public PageResult<DemoDTO> findPage(DemoQuery query) {
        // 构建查询条件
        Specification<Demo> spec = buildSpecification(query);
        
        // 执行分页查询
        Page<Demo> page = demoRepository.findAll(spec, query.toPageable());
        
        // 转换为DTO
        List<DemoDTO> content = page.getContent().stream()
            .map(DemoDTO::fromEntity)
            .collect(Collectors.toList());
        
        return PageResult.of(content, page.getTotalElements());
    }
    
    /**
     * 根据编码查询Demo
     */
    @Cacheable(value = "demo", key = "'code:' + #code")
    public DemoDTO findByCode(String code) {
        return demoRepository.findByCode(code)
            .map(DemoDTO::fromEntity)
            .orElse(null);
    }
}
```

## 数据访问设计

### 仓库接口定义
```java
/**
 * Demo仓库接口
 */
public interface DemoRepository extends JpaRepository<Demo, Long>, JpaSpecificationExecutor<Demo> {
    
    /**
     * 根据编码查询
     */
    Optional<Demo> findByCode(String code);
    
    /**
     * 根据编码判断是否存在
     */
    boolean existsByCode(String code);
    
    /**
     * 根据状态查询
     */
    List<Demo> findByStatus(DemoStatus status);
    
    /**
     * 根据创建时间范围查询
     */
    List<Demo> findByCreatedAtBetween(Date startTime, Date endTime);
}
```

### 数据库表设计
```sql
-- Demo表
CREATE TABLE t_demo (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '名称',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT '编码',
    status VARCHAR(20) NOT NULL COMMENT '状态',
    description VARCHAR(500) COMMENT '描述',
    config JSON COMMENT '配置信息',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    created_by VARCHAR(50) NOT NULL COMMENT '创建人',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    updated_by VARCHAR(50) NOT NULL COMMENT '更新人',
    deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted (deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Demo表';
```

## 缓存设计

### 缓存策略
```java
/**
 * Demo缓存配置
 */
@Configuration
public class DemoCacheConfig {
    
    @Bean
    public Cache demoCache() {
        return CacheBuilder.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(30, TimeUnit.MINUTES)
            .recordStats()
            .build();
    }
}
```

### 缓存更新策略
- **写后删除**: 数据更新后立即删除缓存
- **定时刷新**: 定期刷新缓存数据
- **版本控制**: 使用版本号控制缓存有效性

## 接口设计

### RESTful接口定义
```java
/**
 * Demo接口控制器
 */
@RestController
@RequestMapping("/api/v1/demos")
@Tag(name = "Demo管理", description = "Demo管理相关接口")
public class DemoController {
    
    private final DemoService demoService;
    private final DemoQueryService demoQueryService;
    private final DemoAssembler assembler;
    
    /**
     * 创建Demo
     */
    @PostMapping
    @Operation(summary = "创建Demo")
    public ApiResponse<DemoDTO> createDemo(@Valid @RequestBody CreateDemoRequest request) {
        CreateDemoCommand command = assembler.toCommand(request);
        Demo demo = demoService.createDemo(command);
        return ApiResponse.success(assembler.toDTO(demo));
    }
    
    /**
     * 更新Demo
     */
    @PutMapping("/{id}")
    @Operation(summary = "更新Demo")
    public ApiResponse<DemoDTO> updateDemo(
            @PathVariable Long id,
            @Valid @RequestBody UpdateDemoRequest request) {
        UpdateDemoCommand command = assembler.toCommand(request);
        Demo demo = demoService.updateDemo(id, command);
        return ApiResponse.success(assembler.toDTO(demo));
    }
    
    /**
     * 删除Demo
     */
    @DeleteMapping("/{id}")
    @Operation(summary = "删除Demo")
    public ApiResponse<Void> deleteDemo(@PathVariable Long id) {
        demoService.deleteDemo(id);
        return ApiResponse.success();
    }
    
    /**
     * 根据ID查询Demo
     */
    @GetMapping("/{id}")
    @Operation(summary = "根据ID查询Demo")
    public ApiResponse<DemoDTO> findById(@PathVariable Long id) {
        DemoDTO demo = demoQueryService.findById(id);
        return ApiResponse.success(demo);
    }
    
    /**
     * 分页查询Demo
     */
    @GetMapping
    @Operation(summary = "分页查询Demo")
    public ApiResponse<PageResult<DemoDTO>> findPage(@Valid DemoQueryRequest request) {
        DemoQuery query = assembler.toQuery(request);
        PageResult<DemoDTO> page = demoQueryService.findPage(query);
        return ApiResponse.success(page);
    }
    
    /**
     * 激活Demo
     */
    @PostMapping("/{id}/activate")
    @Operation(summary = "激活Demo")
    public ApiResponse<Void> activateDemo(@PathVariable Long id) {
        demoService.activateDemo(id);
        return ApiResponse.success();
    }
    
    /**
     * 停用Demo
     */
    @PostMapping("/{id}/deactivate")
    @Operation(summary = "停用Demo")
    public ApiResponse<Void> deactivateDemo(@PathVariable Long id) {
        demoService.deactivateDemo(id);
        return ApiResponse.success();
    }
}
```

## 技术实现要点

### 1. 事务管理
- 使用@Transactional注解管理事务边界
- 在领域服务层控制事务
- 支持分布式事务（如需要）

### 2. 异常处理
- 统一的异常处理机制
- 业务异常与系统异常分离
- 友好的错误提示信息

### 3. 日志记录
- 关键业务操作日志记录
- 性能监控日志
- 错误日志详细记录

### 4. 监控指标
- 接口响应时间监控
- 业务指标监控
- 系统资源使用率监控

## 部署方案

### 1. 环境配置
```yaml
# application-demo.yml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://[mysql-host]:3306/demo_db?useSSL=false&serverTimezone=UTC
    username: ${DB_USERNAME:demo_user}
    password: ${DB_PASSWORD:demo_password}
    
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: 0
    timeout: 5000ms
    
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
```

### 2. 部署步骤
1. 数据库表创建和初始化
2. Redis缓存配置
3. 应用服务部署
4. 健康检查和监控配置
5. 接口测试和验证

## 测试策略

### 1. 单元测试
- 领域模型单元测试
- 领域服务单元测试
- 数据访问层单元测试

### 2. 集成测试
- 接口集成测试
- 数据库集成测试
- 缓存集成测试

### 3. 性能测试
- 接口性能测试
- 数据库性能测试
- 缓存性能测试

## 风险评估与应对

### 1. 技术风险
- **数据库性能**: 索引优化、分库分表预案
- **缓存一致性**: 缓存更新策略、失效机制
- **接口稳定性**: 限流、熔断、降级机制

### 2. 业务风险
- **数据一致性**: 事务保证、补偿机制
- **并发冲突**: 乐观锁、悲观锁机制
- **业务规则变更**: 配置化、插件化设计

### 3. 运维风险
- **监控告警**: 完善的监控体系和告警机制
- **故障恢复**: 快速故障定位和恢复方案
- **容量规划**: 资源扩容和性能优化预案